<script defer src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});

const App = {
    elements: {},
    propertiesData: [],
    database: null,
    roiChartInstance: null,

    init() {
        this.cacheDOMElements();
        this.injectHTML();
        this.bindEvents();
        this.setLanguage('en');
        this.connectToDatabase();

        const initialPage = window.location.hash.substring(1) || 'hero-section';
        this.showPage(initialPage, true);
    },

    async connectToDatabase() {
        const firebaseConfig = {
            apiKey: "AIzaSyDvXpEMjcQD9QPJYHRPUk6ohVKv9ohjNBI",
            authDomain: "mermaid-homes.firebaseapp.com",
            databaseURL: "https://mermaid-homes-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mermaid-homes",
            storageBucket: "mermaid-homes.appspot.com",
            messagingSenderId: "652689387599",
            appId: "1:652689387599:web:5bd946f479a0ee92a87a3a",
            measurementId: "G-FDJBSJFP9G"
        };

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            this.database = firebase.database();
            const isConnectionOK = await this.checkFirebaseConnection();
            if (isConnectionOK) {
                this.initRealtimeListener();
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            this.showFatalError();
        }
    },

    async checkFirebaseConnection() {
        const testRef = this.database.ref('connection_test/' + Date.now());
        try {
            await testRef.set({ status: 'ok' });
            await testRef.remove();
            console.log("Firebase connection and write rules are OK.");
            return true;
        } catch (error) {
            console.error("Firebase Rule Check Failed:", error.message);
            this.showFatalError();
            return false;
        }
    },

    initRealtimeListener() {
        const propertiesRef = this.database.ref('properties');
        propertiesRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            this.propertiesData = Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();
            this.filterAndRenderProperties();
            this.hideLoading();
        });
    },

    showFatalError() {
        if (this.elements.loadingOverlay) {
            this.elements.loadingOverlay.style.display = 'none';
        }
        if (this.elements.fatalErrorOverlay) {
            this.elements.fatalErrorOverlay.classList.remove('hidden');
        }
    },

    hideLoading() {
        if (this.elements.loadingOverlay) {
            this.elements.loadingOverlay.style.opacity = 0;
            setTimeout(() => {
                if (this.elements.loadingOverlay && this.elements.loadingOverlay.parentNode) {
                    this.elements.loadingOverlay.parentNode.removeChild(this.elements.loadingOverlay);
                }
            }, 500);
        }
    },

    cacheDOMElements() {
        this.elements.loadingOverlay = document.getElementById('loading-overlay');
        this.elements.fatalErrorOverlay = document.getElementById('fatal-error-overlay');
        this.elements.mainContent = document.getElementById('main-content');
        this.elements.propertiesGrid = document.getElementById('properties-grid');
        this.elements.propertyDetailModal = document.getElementById('property-detail-modal');
    },

    injectHTML() {},
    bindEvents() {},
    setLanguage() {},
    showPage() {},
    showNotification(message, type = 'success') {
        const notif = document.getElementById('notification');
        notif.textContent = message;
        notif.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 3000);
    },

    filterAndRenderProperties() {
        if (!this.elements.propertiesGrid) return;
        const content = this.propertiesData.map(this.getPropertyCardHTML).join('');
        this.elements.propertiesGrid.innerHTML = content;
    },

    getPropertyCardHTML(prop) {
        return `
        <div class="property-card relative cursor-pointer" onclick="App.showPropertyDetail('${prop.id}')">
            <div class="card-banner">
                <img src="${prop.image || 'default.jpg'}" alt="${prop.title}" loading="lazy">
                <span class="card-badge ${prop.status === 'rent' ? 'rent' : ''}">${prop.status || 'For Sale'}</span>
                <button class="delete-property-btn" onclick="event.stopPropagation(); App.deleteProperty('${prop.id}')"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="p-4">
                <h3 class="text-xl font-semibold mb-2">${prop.title}</h3>
                <p class="text-gray-600 text-sm mb-2">${prop.description || ''}</p>
                <div class="text-[var(--primary-color)] font-bold">${prop.price || 'Price on Request'}</div>
            </div>
        </div>
        `;
    },

    showPropertyDetail(propId) {
        const prop = this.propertiesData.find(p => p.id === propId);
        if (!prop) return;

        const content = `
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <img src="${prop.image || 'default.jpg'}" class="w-full h-80 object-cover">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-2">${prop.title}</h2>
                    <p class="text-gray-700 mb-4">${prop.description || 'No description available.'}</p>
                    <div class="text-lg font-semibold text-[var(--primary-color)] mb-4">${prop.price || 'Price on Request'}</div>
                    <button onclick="App.hideModal(App.elements.propertyDetailModal)" class="mt-4 px-4 py-2 bg-gray-700 text-white rounded">Close</button>
                </div>
            </div>
        `;

        this.elements.propertyDetailModal.innerHTML = `<div class="modal-overlay flex items-center justify-center fixed inset-0 bg-black bg-opacity-50 z-50">${content}</div>`;
        this.showModal(this.elements.propertyDetailModal);
    },

    deleteProperty(propId) {
        if (!confirm('Are you sure you want to delete this property?')) return;
        const ref = this.database.ref('properties/' + propId);
        ref.remove().then(() => {
            this.showNotification('Property deleted successfully', 'success');
        }).catch(err => {
            console.error(err);
            this.showNotification('Failed to delete property', 'error');
        });
    },

    handlePropertySubmit() {},
    initScrollAnimations() {},
    hideModal(modalEl) {
        modalEl.innerHTML = '';
    },
    showModal(modalEl) {
        modalEl.style.display = 'flex';
    }
};
</script>
